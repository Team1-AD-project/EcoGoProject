name: EcoGo CI/CD Pipeline
# Trigger CI run after disabling SonarCloud Automatic Analysis

on:
  push:
    branches: [ main, develop, 'feature/**' ]
  pull_request:
    branches: [ main, develop, 'feature/**' ]

env:
  REGISTRY: ghcr.io
  SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

jobs:
  # Stage 1: Code Quality Checks (LINT)
  lint:
    runs-on: ubuntu-latest
    name: Lint & Code Quality
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Run Checkstyle
        run: mvn clean checkstyle:check -DskipTests
        continue-on-error: true

      - name: Generate Checkstyle Report
        if: always()
        run: mvn checkstyle:checkstyle -DskipTests || true

      - name: Upload Lint Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-reports
          path: |
            target/checkstyle-result.xml
            target/site/checkstyle.html
            target/site/checkstyle/
          if-no-files-found: warn

  # Stage 2: Unit Tests (JUnit 5)
  unit-tests:
    runs-on: ubuntu-latest
    name: Unit Tests (JUnit)
    needs: lint
    services:
      mongodb:
        image: mongo:latest
        options: >-
          --health-cmd mongosh
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 27017:27017
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Run Unit Tests
        run: mvn clean test
        env:
          SPRING_DATA_MONGODB_URI: mongodb://localhost:27017/ecogo

      - name: Generate Test Report Summary
        if: always()
        run: |
          echo "=== Unit Test Summary ==="
          if [ -d target/surefire-reports ]; then
            TOTAL=$(find target/surefire-reports -name "TEST-*.xml" | wc -l)
            PASSED=$(grep -l 'failures="0" errors="0"' target/surefire-reports/TEST-*.xml 2>/dev/null | wc -l)
            FAILED=$((TOTAL - PASSED))
            echo "Total test suites: $TOTAL"
            echo "Passed: $PASSED"
            echo "Failed: $FAILED"
          else
            echo "No test reports found"
          fi
          echo "========================="

      - name: Upload Unit Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-reports
          path: |
            target/surefire-reports/
          if-no-files-found: warn

  # Stage 3: SAST (Static Application Security Testing)
  sast:
    runs-on: ubuntu-latest
    name: SAST Analysis
    needs: unit-tests
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Compile Application
        run: mvn clean compile -DskipTests
        continue-on-error: true

      - name: Run SpotBugs
        run: mvn spotbugs:spotbugs -DskipTests
        continue-on-error: true

      - name: Run OWASP Dependency Check
        run: |
          EXTRA_ARGS=""
          if [ -n "$NVD_API_KEY" ]; then
            echo "NVD API Key detected, using it for vulnerability database."
            EXTRA_ARGS="-DnvdApiKey=$NVD_API_KEY"
          else
            echo "WARNING: NVD_API_KEY not set. Using OSS Index only (no NVD data)."
            EXTRA_ARGS="-DnvdDisabled=true"
          fi
          mvn dependency-check:check -DskipTests $EXTRA_ARGS 2>&1 | tee dependency-check.log || echo "Dependency check completed with warnings"
        env:
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
        continue-on-error: true

      - name: Verify SAST Report Files
        if: always()
        run: |
          echo "=== SAST Report Verification ==="
          [ -f target/spotbugsXml.xml ] && echo "✓ SpotBugs XML found" || echo "✗ SpotBugs XML missing"
          [ -f target/spotbugs.html ] && echo "✓ SpotBugs HTML found" || echo "✗ SpotBugs HTML missing"
          [ -f target/dependency-check-report.html ] && echo "✓ Dependency-Check HTML found" || echo "✗ Dependency-Check HTML missing"
          [ -f target/dependency-check-report.json ] && echo "✓ Dependency-Check JSON found" || echo "✗ Dependency-Check JSON missing"
          [ -f target/dependency-check-report.xml ] && echo "✓ Dependency-Check XML found" || echo "✗ Dependency-Check XML missing"
          echo "================================="

      - name: Upload SAST Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sast-reports
          path: |
            target/spotbugsXml.xml
            target/spotbugs.html
            target/dependency-check-report.html
            target/dependency-check-report.xml
            target/dependency-check-report.json
            dependency-check.log
          if-no-files-found: warn

  # Stage 3: Build Application
  build:
    runs-on: ubuntu-latest
    name: Build Application
    needs: sast
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Generate Build Artifacts
        run: |
          mkdir -p build-artifacts
          cp target/EcoGo-*.jar build-artifacts/

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: build-artifacts/

      - name: Build Docker Image
        run: |
          IMAGE_NAME=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')
          docker build -t ${{ env.REGISTRY }}/${IMAGE_NAME}:${{ github.sha }} .
          docker build -t ${{ env.REGISTRY }}/${IMAGE_NAME}:latest .

  # Stage 4: Container Security Scanning
  container-security:
    runs-on: ubuntu-latest
    name: Container Security Scan
    needs: build
    permissions:
      contents: read
      security-events: write
      actions: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Build Docker Image for Scanning
        run: |
          IMAGE_NAME=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')
          docker build -t ${IMAGE_NAME}:scan .
      
      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'team1-ad-project/ecogo:scan'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
        continue-on-error: true
      
      - name: Upload Trivy Results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

      - name: Upload Trivy SARIF (Artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-results
          path: |
            trivy-results.sarif
          if-no-files-found: warn
      
      - name: Run Trivy in Table Format
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'team1-ad-project/ecogo:scan'
          format: 'table'
          output: 'trivy-results.txt'
        continue-on-error: true

      - name: Upload Trivy Table Output (Artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-results-table
          path: |
            trivy-results.txt
          if-no-files-found: warn

      - name: Verify Trivy Evidence
        if: always()
        run: |
          echo "=== Trivy Evidence Verification ==="
          [ -f trivy-results.sarif ] && echo "✓ SARIF report ($(wc -c < trivy-results.sarif) bytes)" || echo "✗ SARIF missing"
          [ -f trivy-results.txt ] && echo "✓ Table report ($(wc -c < trivy-results.txt) bytes)" || echo "✗ Table missing"
          echo "===================================="

  # Stage 5: Code Coverage Gate
  coverage-check:
    runs-on: ubuntu-latest
    name: Code Coverage Gate
    needs: container-security
    services:
      mongodb:
        image: mongo:latest
        options: >-
          --health-cmd mongosh
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 27017:27017
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      
      - name: Run Tests with Coverage
        run: mvn clean verify || echo "Tests completed with some failures"
        continue-on-error: true
        env:
          SPRING_DATA_MONGODB_URI: mongodb://localhost:27017/ecogo
      
      - name: Generate Coverage Report
        run: mvn jacoco:report || echo "Coverage report generated"
        continue-on-error: true
      
      - name: Check Coverage Thresholds
        run: mvn jacoco:check || echo "Coverage below threshold - this is informational only"
        continue-on-error: true

      - name: Verify Coverage Report Files
        if: always()
        run: |
          echo "=== Coverage Report Verification ==="
          [ -f target/site/jacoco/jacoco.csv ] && echo "✓ jacoco.csv found" || echo "✗ jacoco.csv missing"
          [ -f target/site/jacoco/jacoco.xml ] && echo "✓ jacoco.xml found" || echo "✗ jacoco.xml missing"
          [ -f target/site/jacoco/index.html ] && echo "✓ index.html found" || echo "✗ index.html missing"
          echo "==================================="
      
      - name: Upload Coverage Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports
          path: |
            target/site/jacoco/
          if-no-files-found: warn

  # Stage 6: Code Quality Analysis (SonarQube)
  sonarqube:
    runs-on: ubuntu-latest
    name: SonarQube Analysis
    needs: coverage-check
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository
    env:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Download JaCoCo Coverage Reports
        uses: actions/download-artifact@v4
        with:
          name: coverage-reports
          path: target/site/jacoco

      - name: SonarQube Scan
        if: env.SONAR_TOKEN != ''
        run: |
          # NOTE:
          # - Do NOT run `clean` here; we download JaCoCo XML/HTML from the coverage stage.
          # - Do NOT skip compilation; SonarJava needs compiled classes for best accuracy.
          mvn -DskipTests verify sonar:sonar \
            -Dsonar.projectKey=Team1-AD-project_EcoGo \
            -Dsonar.organization=team1-ad-project \
            -Dsonar.sources=src/main \
            -Dsonar.tests=src/test \
            -Dsonar.host.url=${{ env.SONAR_HOST_URL }} \
            -Dsonar.login=${{ env.SONAR_TOKEN }} \
            -Dsonar.projectVersion=${{ github.run_number }} \
            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml
        continue-on-error: true

      - name: SonarQube Not Configured
        if: env.SONAR_TOKEN == ''
        run: echo "WARNING - SonarQube token not configured. Skipping SonarQube analysis. See .github/SECRETS-TEMPLATE.md to configure."

      - name: Upload SonarQube Evidence (Artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sonarqube-evidence
          path: |
            .scannerwork/report-task.txt
            .scannerwork/scanner-report/
            target/sonar/
          if-no-files-found: warn

  # Stage 7: Deploy to Staging Environment
  deploy-staging:
    runs-on: ubuntu-latest
    name: Deploy to Staging
    needs: sonarqube
    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/feature/cicdfeature'
    environment:
      name: staging
    steps:
      - uses: actions/checkout@v4

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: Check AWS Credentials
        id: check_aws
        run: |
          if [ -n "${{ secrets.AWS_ACCESS_KEY_ID }}" ] && [ -n "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
            echo "aws_configured=true" >> $GITHUB_OUTPUT
          else
            echo "aws_configured=false" >> $GITHUB_OUTPUT
          fi

      - name: Configure AWS credentials
        if: steps.check_aws.outputs.aws_configured == 'true'
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Deploy to Staging
        run: |
          echo "Deploying to staging environment..."
          echo "Build artifacts ready for deployment"
        continue-on-error: true

      - name: AWS Not Configured Warning
        if: steps.check_aws.outputs.aws_configured != 'true'
        run: |
          echo "WARNING - AWS credentials not configured. Skipping Terraform deployment."
          echo "NOTE - To enable AWS deployment, configure secrets in Settings → Environments → staging"

  # Stage 8: Deploy to Production Environment
  deploy-production:
    runs-on: ubuntu-latest
    name: Deploy to Production
    needs: sonarqube
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
    steps:
      - uses: actions/checkout@v4

      - name: Manual Approval Required
        run: echo "Waiting for manual approval in GitHub Environments..."

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: Check AWS Credentials
        id: check_aws
        run: |
          if [ -n "${{ secrets.AWS_ACCESS_KEY_ID }}" ] && [ -n "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
            echo "aws_configured=true" >> $GITHUB_OUTPUT
          else
            echo "aws_configured=false" >> $GITHUB_OUTPUT
          fi

      - name: Configure AWS credentials
        if: steps.check_aws.outputs.aws_configured == 'true'
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Deploy to Production
        run: |
          echo "Deploying to production environment..."
          echo "Build artifacts ready for deployment"
        continue-on-error: true

      - name: AWS Not Configured Warning
        if: steps.check_aws.outputs.aws_configured != 'true'
        run: |
          echo "WARNING - AWS credentials not configured. Skipping Terraform deployment."
          echo "NOTE - To enable AWS deployment, configure secrets in Settings → Environments → production"

  # Stage 6: Run Integration Tests
  integration-tests:
    runs-on: ubuntu-latest
    name: Integration Tests
    needs: deploy-staging
    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/feature/cicdfeature'
    services:
      mongodb:
        image: mongo:latest
        options: >-
          --health-cmd mongosh
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 27017:27017
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Wait for MongoDB
        run: sleep 10

      - name: Run Integration Tests
        run: mvn clean verify -Dspring.data.mongodb.uri=mongodb://localhost:27017/ecogo || echo "Integration tests completed with warnings"
        continue-on-error: true
        env:
          MONGODB_HOST: localhost
          MONGODB_PORT: 27017
          SPRING_DATA_MONGODB_URI: mongodb://localhost:27017/ecogo

      - name: Upload Test Reports (Artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            target/surefire-reports/
            target/failsafe-reports/
          if-no-files-found: warn

  # Stage 7: Smoke Tests
  smoke-tests-staging:
    runs-on: ubuntu-latest
    name: Smoke Tests - Staging
    needs: deploy-staging
    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/feature/cicdfeature'
    services:
      mongodb:
        image: mongo:latest
        options: >-
          --health-cmd mongosh
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 27017:27017
    steps:
      - uses: actions/checkout@v4
      
      - name: Check if real deployment exists
        id: check_deployment
        run: |
          if [ -n "${{ secrets.STAGING_URL }}" ]; then
            echo "has_deployment=true" >> $GITHUB_OUTPUT
            echo "target_url=${{ secrets.STAGING_URL }}" >> $GITHUB_OUTPUT
          else
            echo "has_deployment=false" >> $GITHUB_OUTPUT
            echo "target_url=http://localhost:8090" >> $GITHUB_OUTPUT
          fi
      
      - name: Download Build Artifacts (if no real deployment)
        if: steps.check_deployment.outputs.has_deployment != 'true'
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
      
      - name: Set up JDK 17 (if no real deployment)
        if: steps.check_deployment.outputs.has_deployment != 'true'
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Start Local Application (if no real deployment)
        if: steps.check_deployment.outputs.has_deployment != 'true'
        run: |
          echo "Starting application locally for smoke tests..."
          if ls build-artifacts/*.jar 1> /dev/null 2>&1; then
            cp build-artifacts/*.jar app.jar
          elif ls *.jar 1> /dev/null 2>&1; then
            cp *.jar app.jar
          else
            echo "ERROR: No JAR found after downloading build artifacts."
            ls -la
            exit 1
          fi

          nohup java -jar app.jar > app.log 2>&1 &
          
          # Wait for application to start
          for i in {1..30}; do
            if curl -s http://localhost:8090/actuator/health > /dev/null 2>&1; then
              echo "Application is ready!"
              break
            fi
            echo "Waiting for application... ($i/30)"
            sleep 3
          done
        env:
          SPRING_DATA_MONGODB_URI: mongodb://localhost:27017/ecogo
          SERVER_PORT: 8090
      
      - name: Wait for Deployment (if real deployment)
        if: steps.check_deployment.outputs.has_deployment == 'true'
        run: sleep 30
      
      - name: Run Smoke Tests
        run: |
          chmod +x .github/scripts/smoke-tests.sh
          ./.github/scripts/smoke-tests.sh ${{ steps.check_deployment.outputs.target_url }}
        continue-on-error: true
      
      - name: Test Critical API Endpoints
        run: |
          echo "Testing API endpoints..."
          curl -f ${{ steps.check_deployment.outputs.target_url }}/actuator/health || echo "Health check completed"
        continue-on-error: true

      - name: Upload Smoke Test Logs (Artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-logs
          path: |
            app.log
          if-no-files-found: ignore

  smoke-tests-production:
    runs-on: ubuntu-latest
    name: Smoke Tests - Production
    needs: deploy-production
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      
      - name: Check if real deployment exists
        id: check_deployment
        run: |
          if [ -n "${{ secrets.PRODUCTION_URL }}" ]; then
            echo "has_deployment=true" >> $GITHUB_OUTPUT
            echo "Production deployment URL configured"
          else
            echo "has_deployment=false" >> $GITHUB_OUTPUT
            echo "WARNING: No production URL configured, skipping smoke tests"
          fi
      
      - name: Wait for Deployment
        if: steps.check_deployment.outputs.has_deployment == 'true'
        run: sleep 30
      
      - name: Run Smoke Tests
        if: steps.check_deployment.outputs.has_deployment == 'true'
        run: |
          chmod +x .github/scripts/smoke-tests.sh
          ./.github/scripts/smoke-tests.sh ${{ secrets.PRODUCTION_URL }}
        continue-on-error: true
      
      - name: Test Critical API Endpoints
        if: steps.check_deployment.outputs.has_deployment == 'true'
        run: |
          echo "Testing API endpoints..."
          curl -f ${{ secrets.PRODUCTION_URL }}/actuator/health || echo "Health check completed"
        continue-on-error: true
      
      - name: Skip Smoke Tests Warning
        if: steps.check_deployment.outputs.has_deployment != 'true'
        run: |
          echo "⚠️ Smoke tests skipped - no production deployment URL configured"
          echo "Configure PRODUCTION_URL secret to enable production smoke tests"

  # Stage 8: Performance Tests
  performance-tests:
    runs-on: ubuntu-latest
    name: Performance Tests - JMeter
    needs: sonarqube
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/feature/cicdfeature'
    services:
      mongodb:
        image: mongo:latest
        options: >-
          --health-cmd mongosh
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 27017:27017
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
      
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Wait for MongoDB
        run: sleep 10
      
      - name: Start Application
        run: |
          echo "Starting application for performance tests..."
          if ls build-artifacts/*.jar 1> /dev/null 2>&1; then
            cp build-artifacts/*.jar app.jar
          elif ls *.jar 1> /dev/null 2>&1; then
            cp *.jar app.jar
          else
            echo "ERROR: No JAR found after downloading build artifacts."
            ls -la
            exit 1
          fi

          nohup java -jar app.jar > app.log 2>&1 &
          
          # Wait for application to start
          for i in {1..30}; do
            if curl -s http://localhost:8090/actuator/health > /dev/null 2>&1; then
              echo "Application is ready!"
              break
            fi
            echo "Waiting for application... ($i/30)"
            sleep 3
          done
        env:
          SPRING_DATA_MONGODB_URI: mongodb://localhost:27017/ecogo
          SERVER_PORT: 8090
      
      - name: Run JMeter Tests
        run: |
          echo "Running JMeter performance tests..."
          docker run --network="host" \
            -v $(pwd)/performance-tests:/tests \
            justb4/jmeter \
            -n -t /tests/load-test.jmx \
            -l /tests/results.jtl \
            -j /tests/jmeter.log \
            -Jhost=localhost -Jport=8090 \
            -Jthreads=50 -Jloops=20 \
            -Jlogin_userid=E1538488 -Jlogin_password=123456 \
            -e -o /tests/report || echo "JMeter tests completed"
        continue-on-error: true
      
      - name: Upload Performance Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: jmeter-report
          path: performance-tests/report/
          if-no-files-found: warn

      - name: Upload Performance Raw Results (Artifact)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: jmeter-raw
          path: |
            performance-tests/results.jtl
            app.log
          if-no-files-found: ignore
      
      - name: Check Performance Baseline
        run: |
          echo "Checking performance metrics..."
          if [ -f performance-tests/results.jtl ]; then
            echo "Performance test results available"
          fi
        continue-on-error: true

  # Stage 9: DAST (Dynamic Application Security Testing)
  dast:
    runs-on: ubuntu-latest
    name: DAST with OWASP ZAP
    needs: performance-tests
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/feature/cicdfeature'
    services:
      mongodb:
        image: mongo:latest
        options: >-
          --health-cmd mongosh
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 27017:27017
    steps:
      - uses: actions/checkout@v4

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Wait for MongoDB
        run: |
          echo "Waiting for MongoDB to be ready..."
          sleep 15

      - name: Start Application
        run: |
          echo "Starting EcoGo application..."
          if ls build-artifacts/*.jar 1> /dev/null 2>&1; then
            cp build-artifacts/*.jar app.jar
          elif ls *.jar 1> /dev/null 2>&1; then
            cp *.jar app.jar
          else
            echo "ERROR: No JAR found after downloading build artifacts."
            ls -la
            exit 1
          fi

          nohup java -jar app.jar > app.log 2>&1 &
          APP_PID=$!
          echo "Application started with PID: $APP_PID"
          
          # Wait for application to start with retries
          echo "Waiting for application to be ready..."
          for i in {1..30}; do
            if curl -s http://localhost:8090/actuator/health > /dev/null 2>&1; then
              echo "Application is ready!"
              break
            fi
            echo "Attempt $i/30: Application not ready yet, waiting..."
            sleep 3
          done
          
          echo "=== Application Logs ==="
          cat app.log || true
          echo "========================"
        env:
          SPRING_DATA_MONGODB_URI: mongodb://localhost:27017/ecogo
          SERVER_PORT: 8090
          
      - name: Verify Application Health
        run: |
          echo "Checking application health..."
          curl -v http://localhost:8090/actuator/health || {
            echo "Health check failed! Application logs:"
            cat app.log || true
            exit 1
          }

      - name: Prepare ZAP Output Directory
        run: |
          mkdir -p dast-report
          chmod 777 dast-report

      - name: Run OWASP ZAP Baseline Scan
        run: |
          echo "Starting OWASP ZAP baseline scan..."
          docker run --rm --network="host" \
            -v $(pwd)/dast-report:/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable zap-baseline.py \
            -t http://localhost:8090 \
            -I \
            -r zap-report.html \
            -w zap-report.md \
            -J zap-report.json \
            -x zap-report.xml \
            2>&1 | tee dast-report/zap-scan.log || echo "ZAP baseline scan completed"
        continue-on-error: true

      - name: Run OWASP ZAP Full Scan
        run: |
          echo "Starting OWASP ZAP full scan..."
          docker run --rm --network="host" \
            -v $(pwd)/dast-report:/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable zap-full-scan.py \
            -t http://localhost:8090 \
            -I \
            -m 5 \
            -r zap-report-full.html \
            -w zap-report-full.md \
            -J zap-report-full.json \
            -x zap-report-full.xml \
            2>&1 | tee dast-report/zap-full-scan.log || echo "ZAP full scan completed"
        continue-on-error: true

      - name: Verify ZAP Reports
        if: always()
        run: |
          echo "=== ZAP Report Verification ==="
          for f in zap-report.html zap-report.json zap-report.xml zap-report.md \
                   zap-report-full.html zap-report-full.json zap-report-full.xml zap-report-full.md; do
            if [ -f "dast-report/$f" ] && [ -s "dast-report/$f" ]; then
              echo "✓ $f ($(wc -c < dast-report/$f) bytes)"
            else
              echo "✗ $f missing or empty"
            fi
          done

          # Create fallbacks only if baseline reports are all missing
          if [ ! -f "dast-report/zap-report.json" ] || [ ! -s "dast-report/zap-report.json" ]; then
            echo "Creating fallback reports (see zap-scan.log for scan details)..."
            echo '{"@version":"0.0.0","site":[],"_note":"Fallback - ZAP did not produce reports, see zap-scan.log"}' > dast-report/zap-report.json
          fi
          if [ ! -f "dast-report/zap-report.xml" ] || [ ! -s "dast-report/zap-report.xml" ]; then
            echo '<?xml version="1.0"?><OWASPZAPReport version="0.0.0"><site></site></OWASPZAPReport>' > dast-report/zap-report.xml
          fi
          if [ ! -f "dast-report/zap-report.html" ] || [ ! -s "dast-report/zap-report.html" ]; then
            echo "<html><body><h1>OWASP ZAP - Fallback</h1><p>ZAP did not produce reports. See zap-scan.log in artifacts.</p></body></html>" > dast-report/zap-report.html
          fi
          if [ ! -f "dast-report/zap-report.md" ] || [ ! -s "dast-report/zap-report.md" ]; then
            echo "# OWASP ZAP - Fallback Report" > dast-report/zap-report.md
            echo "" >> dast-report/zap-report.md
            echo "ZAP did not produce reports. See zap-scan.log in artifacts." >> dast-report/zap-report.md
          fi

          echo ""
          echo "=== Final dast-report contents ==="
          ls -lh dast-report/

      - name: Upload DAST Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dast-report
          path: |
            dast-report/
            app.log
          if-no-files-found: warn

  # Stage 10: Setup Monitoring (Prometheus & Grafana)
  monitoring-setup:
    runs-on: ubuntu-latest
    name: Setup Monitoring Stack
    needs: [dast]
    if: always() && (github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/feature/cicdfeature')
    steps:
      - uses: actions/checkout@v4

      - name: Deploy Prometheus
        run: |
          docker run -d --name prometheus \
            -v $(pwd)/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml \
            -p 9090:9090 \
            prom/prometheus:latest
        continue-on-error: true

      - name: Deploy Grafana
        run: |
          docker run -d --name grafana \
            -e GF_SECURITY_ADMIN_PASSWORD=admin \
            -p 3000:3000 \
            grafana/grafana:latest
        continue-on-error: true

      - name: Configure Grafana Data Source
        run: |
          sleep 10
          curl -X POST http://localhost:3000/api/datasources \
            -H "Content-Type: application/json" \
            -d '{"name":"Prometheus","type":"prometheus","url":"http://localhost:9090","access":"proxy","isDefault":true}' \
            -u admin:admin
        continue-on-error: true

  # Stage 11: Production Monitoring
  monitoring-setup-production:
    runs-on: ubuntu-latest
    name: Setup Monitoring Stack - Production
    needs: smoke-tests-production
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Deploy Prometheus
        run: |
          echo "Production monitoring setup..."
          # Add production-specific monitoring configuration
        continue-on-error: true

  # Final Status Report
  pipeline-status:
    runs-on: ubuntu-latest
    name: Pipeline Status
    needs: [lint, unit-tests, sast, build, container-security, coverage-check, sonarqube]
    if: always()
    steps:
      - name: Pipeline Summary
        run: |
          echo "========================================"
          echo "  EcoGo CI/CD Pipeline Summary"
          echo "========================================"
          echo "Workflow : ${{ github.workflow }}"
          echo "Commit   : ${{ github.sha }}"
          echo "Branch   : ${{ github.ref }}"
          echo ""
          echo "Stage Results:"
          echo "  Lint (Checkstyle)       : ${{ needs.lint.result }}"
          echo "  Unit Tests (JUnit)      : ${{ needs.unit-tests.result }}"
          echo "  SAST (SpotBugs + DC)    : ${{ needs.sast.result }}"
          echo "  Build                   : ${{ needs.build.result }}"
          echo "  Container Security      : ${{ needs.container-security.result }}"
          echo "  Coverage (JaCoCo)       : ${{ needs.coverage-check.result }}"
          echo "  SonarQube               : ${{ needs.sonarqube.result }}"
          echo ""
          echo "Evidence artifacts uploaded:"
          echo "  - lint-reports (Checkstyle HTML/XML)"
          echo "  - unit-test-reports (Surefire XML/TXT)"
          echo "  - sast-reports (SpotBugs XML + Dependency-Check HTML/JSON/XML)"
          echo "  - trivy-results (SARIF)"
          echo "  - trivy-results-table (text)"
          echo "  - coverage-reports (JaCoCo CSV/XML/HTML)"
          echo "  - sonarqube-evidence (report-task.txt)"
          echo "  - jmeter-report (HTML dashboard)"
          echo "  - dast-report (ZAP HTML/JSON/XML/MD)"
          echo "========================================"
